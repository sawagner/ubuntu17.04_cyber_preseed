# Initial preseed implementation for LCSEE Systems lxenial release.

### Localization
# Preseeding only locale sets language, country and locale.
d-i debian-installer/locale string en_US.UTF-8

# Keyboard selection.
# Disable automatic (interactive) keymap detection.
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select us
d-i keyboard-configuration/layoutcode      string  us
d-i keyboard-configuration/layout          select  English (US)


### Network configuration

# netcfg will choose an interface that has link if possible. This makes it
# skip displaying a list if there is more than one interface.
d-i netcfg/choose_interface select auto

# Any hostname and domain names assigned from dhcp take precedence over
# values set here. However, setting the values still prevents the questions
# from being shown, even if values come from dhcp.
d-i netcfg/get_hostname string unassigned-hostname
d-i netcfg/get_domain string unassigned-domain

# If you want to force a hostname, regardless of what either the DHCP
# server returns or what the reverse DNS entry for the IP is, uncomment
# and adjust the following line.
d-i netcfg/hostname string ubuntu

# Disable that annoying WEP key dialog.
d-i netcfg/wireless_wep string


### Mirror settings
# If you select ftp, the mirror/country string does not need to be set.
d-i mirror/country string manual
d-i mirror/http/hostname string mirror.lcsee.wvu.edu
d-i mirror/http/directory string /ubuntu
d-i mirror/http/proxy       http://squid.lcsee.wvu.edu:3128/
d-i mirror/suite string xenial
d-i apt-setup/security_host string mirror.lcsee.wvu.edu
d-i apt-setup/security_path string /ubuntu

# LOUD repositories
# Discovered a bug during lxerus development.
#  The "repository" commands require "deb" before the URL, which was
#  not required in earlier releases.
#  https://bugs.launchpad.net/ubuntu/+source/base-installer/+bug/1512347
d-i apt-setup/local0/repository string deb http://loud.lcsee.wvu.edu/stable/ lxerus/
d-i apt-setup/local0/comment string LOUD Stable
d-i apt-setup/local0/source boolean true
d-i apt-setup/local0/key string http://loud.lcsee.wvu.edu/test/lcsee_repo.gpg
d-i apt-setup/local1/repository string deb http://loud.lcsee.wvu.edu/test/ lxerus-test/
d-i apt-setup/local1/comment string LOUD Test
d-i apt-setup/local1/source boolean true
d-i apt-setup/local1/key string http://loud.lcsee.wvu.edu/test/lcsee_repo.gpg
d-i apt-setup/local2/repository string deb http://loud.lcsee.wvu.edu/stable/ lxerus-internal/
d-i apt-setup/local2/comment string LOUD Stable
d-i apt-setup/local2/source boolean true
d-i apt-setup/local2/key string http://loud.lcsee.wvu.edu/test/lcsee_repo.gpg
d-i apt-setup/local3/repository string deb http://loud.lcsee.wvu.edu/test/ lxerus-internal-test/
d-i apt-setup/local3/comment string LOUD Test
d-i apt-setup/local3/source boolean true
d-i apt-setup/local3/key string http://loud.lcsee.wvu.edu/test/lcsee_repo.gpg


### Account setup
# Skip creation of a root account (normal user account will be able to
# use sudo). The default is false; preseed this to true if you want to set
# a root password.
d-i passwd/root-login boolean false

# Alternatively, to skip creation of a normal user account.
d-i passwd/make-user boolean true

# To create a normal user account named loud. This will immediately be deleted
#  using a late install command.
d-i passwd/user-fullname string LOUD
d-i passwd/username string loud
d-i passwd/user-password password loud
d-i passwd/user-password-again password loud
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false



### Clock and time zone setup

# Controls whether or not the hardware clock is set to UTC.
d-i clock-setup/utc boolean true

# You may set this to any valid setting for $TZ; see the contents of
# /usr/share/zoneinfo/ for valid values.
d-i time/zone string US/Eastern

# Controls whether to use NTP to set the clock during the install
d-i clock-setup/ntp boolean true


### Package selection
tasksel tasksel/first multiselect ubuntu-desktop

# Policy for applying updates. May be "none" (no automatic updates),
# "unattended-upgrades" (install security updates automatically), or
# "landscape" (manage system with Landscape).
d-i pkgsel/update-policy select none


### Boot loader installation

# This is fairly safe to set, it makes grub install automatically to the MBR
# if no other operating system is detected on the machine.
d-i grub-installer/only_debian boolean true

# This one makes grub-installer install to the MBR if it also finds some other
# OS, which is less safe as it might not be able to boot that other OS.
#d-i grub-installer/with_other_os boolean true

# Optional password for grub, either in clear text
#d-i grub-installer/password password r00tme
#d-i grub-installer/password-again password r00tme
# or encrypted using an MD5 hash, see grub-md5-crypt(8).
#d-i grub-installer/password-crypted password [MD5 hash]

# Use the following option to add additional boot parameters for the
# installed system (if supported by the bootloader installer).
# Note: options passed to the installer will be added automatically.
#d-i debian-installer/add-kernel-opts string nousb


### Finishing up the installation

# Avoid that last message about the install being complete.
d-i finish-install/reboot_in_progress note


### Preseeding other packages
# Depending on what software you choose to install, or if things go wrong
# during the installation process, it's possible that other questions may
# be asked. You can preseed those too, of course. To get a list of every
# possible question that could be asked during an install, do an
# installation, and then run these commands:
#   debconf-get-selections --installer > file
#   debconf-get-selections >> file


#### Advanced options

# This command is run just before the install finishes, but when there is
# still a usable /target directory. You can chroot to /target and use it
# directly, or use the apt-install and in-target commands to easily install
# packages and run commands in the target system.
d-i preseed/late_command string \
cp /keys/* /target/etc/ssh/;\
chmod 600 /target/etc/ssh/ssh_host*;\
chmod a+r /target/etc/ssh/*.pub;\
in-target apt-get install -y --allow-unauthenticated openssh-server lcsee-sysstaff-sshkeyauth loud-apt lcsee-apt loud-ubuntu-ansible/lxerus lcsee-ubuntu-ansible/lxerus-internal;\
in-target deluser --remove-all-files loud || /bin/true;\
in-target ansible-playbook /opt/loud/ansible/loud-ubuntu-ansible/external.yml;\
in-target ansible-playbook /opt/loud/ansible/lcsee-ubuntu-ansible/233aer-desktop.yml;
